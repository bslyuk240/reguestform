<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JulineMart • Admin</title>
<link rel="icon" href="logo.png">
<style>
  :root{--jm-primary:#08A045;--jm-dark:#0E141B;--jm-border:#E7EAEE;}
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{background:#0E141B;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:28px;height:28px;border-radius:6px}
  .btn{cursor:pointer;padding:8px 10px;border-radius:8px;border:1px solid var(--jm-border);background:#fff}
  .btn.primary{background:var(--jm-primary);color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--jm-border);border-radius:12px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  input,select{width:100%;padding:9px;border:1px solid #d8dbe0;border-radius:10px;font:inherit}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
  .Pending{background:#fff3cd;border:1px solid #ffe69c}
  .Approved{background:#d1e7dd;border:1px solid #a3cfbb}
  .Declined{background:#f8d7da;border:1px solid #f1aeb5}
  .Paid{background:#cff4fc;border:1px solid #9eeaf9}
  .hidden{display:none !important}
  #paid-totals{font-size:14px;background:#f6f8fa;border:1px solid #e7eaee;padding:6px 10px;border-radius:8px}
  .foot{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt=""><b>JulineMart • Admin</b>
  </div>
  <div>
    <span id="whoami"></span>
    <button id="btn-signout" class="btn hidden" type="button">Sign out</button>
  </div>
</header>

<main>
  <!-- Login -->
  <section id="auth" class="card">
    <h3>Admin sign-in</h3>
    <form id="admin-form" novalidate>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@julinemart.com" required />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="Password" required />
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-login" class="btn primary" type="submit">Log in</button>
        <a href="staff.html" class="btn" style="text-decoration:none">Go to Staff</a>
      </div>
      <p id="auth-msg" class="foot"></p>
    </form>
  </section>

  <!-- Filters + totals -->
  <section id="admin-top" class="card hidden" style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <h3 style="margin:0">All Requests</h3>
      <div class="row" style="margin-top:8px">
        <div><select id="f-status"><option value="">Status: All</option><option>Pending</option><option>Approved</option><option>Declined</option><option>Paid</option></select></div>
        <div><select id="f-kind"><option value="">Type: All</option><option value="petty_cash">Petty Cash</option><option value="reimbursement">Reimbursement</option></select></div>
        <div><input id="f-from" type="date"></div>
        <div><input id="f-to" type="date"></div>
        <div style="flex:0 0 auto"><button id="btn-filter" class="btn" type="button">Apply</button></div>
        <div style="flex:0 0 auto"><button id="btn-clear" class="btn" type="button">Clear</button></div>
      </div>
    </div>
    <div style="text-align:right">
      <div id="paid-totals" title="Sum of PAID requests (respects date filters)">Totals: —</div>
      <button id="btn-export" class="btn primary" type="button" style="margin-top:8px">Export CSV</button>
    </div>
  </section>

  <!-- Table -->
  <section id="admin-table-wrap" class="card hidden">
    <table id="admin-table">
      <thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th><th>Action</th><th>Receipt</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="totals.js"></script>
<script>
/* Fallback if totals.js not present */
const JT = window.JMTotals || {
  summarizePaidTotals: rows => (rows||[]).reduce((m,r)=>{const c=(String(r?.currency??'').trim()||'UNK'); const a=Number(r?.amount??0)||0; m[c]=(m[c]||0)+a; return m;},{}),
  formatPaidTotalsLabel: t => { const e=Object.entries(t||{}); return e.length ? 'Totals: '+e.map(([c,s])=>`${c} ${s.toFixed(2)}`).join(' • ') : 'Totals: 0'; }
};

const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o",
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false  // we’re not using magic-link redirects here
    }
  }
);

const $=(id)=>document.getElementById(id);
const UI={who:$('whoami'),out:$('btn-signout'),auth:$('auth'),msg:$('auth-msg'),
          top:$('admin-top'),wrap:$('admin-table-wrap'),tbody:document.querySelector('#admin-table tbody'),
          totals:$('paid-totals'),form:$('admin-form'),email:$('email'),password:$('password')};
let me=null;

UI.top.classList.add('hidden'); UI.wrap.classList.add('hidden'); UI.out.classList.add('hidden');
function showAdminUI(show){ UI.auth.classList.toggle('hidden',show); UI.top.classList.toggle('hidden',!show); UI.wrap.classList.toggle('hidden',!show); UI.out.classList.toggle('hidden',!show); }

async function init(){
  const {data:{session}, error:sErr}=await sb.auth.getSession();
  if(sErr){ UI.msg.textContent='Session error: '+sErr.message; return; }
  me=session?.user||null;
  if(!me){ UI.who.textContent=''; showAdminUI(false); return; }

  UI.who.textContent=me.email;
  const {data:prof, error:rErr}=await sb.from('profiles').select('role').eq('user_id',me.id).maybeSingle();
  if(rErr){ UI.msg.textContent='Role check failed: '+rErr.message; showAdminUI(false); return; }
  if((prof?.role||'staff')!=='admin'){ UI.msg.textContent='Access denied (not admin).'; showAdminUI(false); await sb.auth.signOut(); return; }

  showAdminUI(true);
  await load(); calcTotals();
}
sb.auth.onAuthStateChange(init); init();

/* Login */
const form = document.getElementById('admin-form');
const msg  = document.getElementById('auth-msg');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = 'Logging in…';
  try {
    const email = document.getElementById('email').value.trim();
    const pw    = document.getElementById('password').value.trim();
    if (!email || !pw) { msg.textContent = 'Enter email & password.'; return; }

    const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
    if (error) throw error;

    // Use the session we already have, don’t wait on getSession
    const session = data?.session;
    if (!session) {
      // Fallback: read once (some browsers delay writes)
      const g = await sb.auth.getSession();
      if (!g?.data?.session) {
        msg.textContent = 'Logged in, but no session was created. Clear cache/service worker and retry.';
        return;
      }
    }

    // Role check -> show UI right away
    msg.textContent = 'Checking admin role…';
    const uid = (data?.session?.user?.id) || (await sb.auth.getUser()).data?.user?.id;
    const { data: prof, error: roleErr } = await sb.from('profiles')
      .select('role').eq('user_id', uid).maybeSingle();
    if (roleErr) { msg.textContent = 'Role check failed: ' + roleErr.message; return; }
    if ((prof?.role || 'staff') !== 'admin') { msg.textContent = 'Access denied (not admin).'; return; }

    msg.textContent = 'Welcome.';
    showAdminUI(true);
    await load();
    await calcTotals();
  } catch (err) {
    console.error('Admin login failed:', err);
    msg.textContent = (err && err.message) || String(err);
  }
});

/* Sign out */
UI.out.onclick=async()=>{ try{ await sb.auth.signOut(); } finally { showAdminUI(false); location.href='staff.html'; } };

/* Helpers */
function pill(s){return `<span class="pill ${s}">${s}</span>`;}
function fmt(a,c){return `${c} ${Number(a||0).toFixed(2)}`;}
async function signedUrl(path){ if(!path) return ''; const {data}=await sb.storage.from('receipts').createSignedUrl(path,600); return data?.signedUrl||''; }
const nameCache=new Map();
async function nameFor(user_id){ if(nameCache.has(user_id)) return nameCache.get(user_id);
  const {data}=await sb.from('profiles').select('full_name,email').eq('user_id',user_id).maybeSingle();
  const name=(data?.full_name&&data.full_name.trim())||data?.email||(user_id||'').slice(0,8);
  nameCache.set(user_id,name); return name; }
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

/* Data */
function readFilters(){ return { status:$('f-status').value||null, kind:$('f-kind').value||null, from:$('f-from').value||null, to:$('f-to').value||null }; }
async function fetchRequests(f={}){ let q=sb.from('requests').select('*').order('created_at',{ascending:false});
  if(f.status) q=q.eq('status',f.status); if(f.kind) q=q.eq('kind',f.kind);
  if(f.from) q=q.gte('created_at',f.from+'T00:00:00Z'); if(f.to) q=q.lte('created_at',f.to+'T23:59:59Z');
  const {data,error}=await q; if(error) throw error; return data||[]; }

let LOAD_TOKEN=0;
async function load(f=readFilters()){
  const token=++LOAD_TOKEN; UI.tbody.innerHTML='<tr><td colspan="8">Loading…</td></tr>';
  try{
    const rows=await fetchRequests(f); if(token!==LOAD_TOKEN) return; UI.tbody.innerHTML='';
    for(const r of rows){
      const staff=await nameFor(r.user_id);
      const {data:notes}=await sb.from('request_notes').select('note').eq('request_id',r.id);
      const rec=(notes||[]).find(n=>typeof n.note==='string' && n.note.startsWith('receipt:'));
      const link=rec?`<a target="_blank" rel="noopener" href="${await signedUrl(rec.note.replace('receipt:',''))}">View</a>`:'';
      const sel=`sel-${r.id}`, com=`com-${r.id}`, btn=`btn-${r.id}`;
      const options=['Pending','Approved','Declined','Paid'].map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('');
      const descSafe=escapeHtml(r.description||'');
      UI.tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
          <td>${staff}</td>
          <td>${r.kind.replace('_',' ')}</td>
          <td title="${descSafe}">${descSafe}</td>
          <td>${fmt(r.amount,r.currency)}</td>
          <td>${pill(r.status)}</td>
          <td>
            <div class="row" style="gap:6px;align-items:center">
              <div style="flex:1 1 120px"><select id="${sel}">${options}</select></div>
              <div style="flex:2 1 260px"><input id="${com}" placeholder="Comment to staff (reason / note)"></div>
              <div style="flex:0 0 auto"><button id="${btn}" class="btn" type="button">Update</button></div>
            </div>
          </td>
          <td>${link}</td>
        </tr>`);
      document.getElementById(btn).onclick=()=>updateStatus(r.id,document.getElementById(sel).value,document.getElementById(com).value.trim());
    }
  }catch(err){ UI.tbody.innerHTML=`<tr><td colspan="8">${err.message||String(err)}</td></tr>`; }
}

async function updateStatus(id,next,comment){
  try{
    if(next==='Paid'){
      const method=prompt('Payment method (e.g., Transfer, Cash, PayPal):','Transfer'); if(method===null) return;
      const reference=prompt('Reference / Transaction ID:','');
      await sb.from('payouts').insert({request_id:id,paid_by:me.id,method,reference});
    }
    await sb.from('requests').update({status:next}).eq('id',id);
    if(comment) await sb.from('request_notes').insert({request_id:id,author_id:me.id,note:comment});
    await sb.from('request_notes').insert({request_id:id,author_id:me.id,note:`Status -> ${next}`});
    await load(); calcTotals();
  }catch(err){ alert(err.message||String(err)); }
}

async function calcTotals(){
  const f=readFilters();
  let q=sb.from('requests').select('amount,currency').eq('status','Paid');
  if(f.from) q=q.gte('created_at',f.from+'T00:00:00Z');
  if(f.to)   q=q.lte('created_at',f.to+'T23:59:59Z');
  const {data,error}=await q; if(error){ UI.totals.textContent='Totals: error'; return; }
  const totals = JT.summarizePaidTotals(data||[]);
  UI.totals.textContent = JT.formatPaidTotalsLabel(totals);
}

/* Filters + export */
$('btn-filter').onclick=()=>{ load(); calcTotals(); };
$('btn-clear').onclick =()=>{ $('f-status').value=''; $('f-kind').value=''; $('f-from').value=''; $('f-to').value=''; load(); calcTotals(); };
$('btn-export').onclick=async()=>{ const {data,error}=await sb.from('requests').select('*').order('created_at',{ascending:false});
  if(error){ alert(error.message); return; }
  const rows=[['created_at','user_id','kind','description','amount','currency','needed_by','status','updated_at','id']];
  (data||[]).forEach(r=>rows.push([r.created_at,r.user_id,r.kind,r.description||'',r.amount,r.currency,r.needed_by||'',r.status,r.updated_at,r.id]));
  const csv=rows.map(r=>r.map(x=>{const s=String(x==null?'':x);return '"'+s.split('"').join('""')+'"';}).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='julinemart_requests.csv'; a.click(); URL.revokeObjectURL(url); };
</script>
</body>
</html>
