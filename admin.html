<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JulineMart • Admin</title>
<link rel="icon" href="logo.png">
<style>
  :root{--jm-primary:#08A045;--jm-dark:#0E141B;--jm-bg:#F6F8FA;--jm-border:#E7EAEE;}
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{background:#0E141B;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
  .brand b{font-size:16px}
  .btn{cursor:pointer;padding:9px 12px;border-radius:9px;border:1px solid var(--jm-border);background:#fff}
  .btn.primary{background:var(--jm-primary);color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--jm-border);border-radius:12px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  input,select{width:100%;padding:10px;border:1px solid #d8dbe0;border-radius:10px;font:inherit}
  table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
  .Pending{background:#fff3cd;border:1px solid #ffe69c}
  .Approved{background:#d1e7dd;border:1px solid #a3cfbb}
  .Declined{background:#f8d7da;border:1px solid #f1aeb5}
  .Paid{background:#cff4fc;border:1px solid #9eeaf9}
  .hidden{display:none}
  .foot{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="">
    <div>
      <b>JulineMart • Admin</b>
      <div class="foot">Petty Cash & Reimbursements</div>
    </div>
  </div>
  <div>
    <span id="whoami"></span>
    <button id="btn-signout" class="btn hidden" type="button">Sign out</button>
  </div>
</header>

<main>
  <!-- Admin login -->
  <section id="auth" class="card hidden">
    <h3>Admin sign-in</h3>
    <div class="row">
      <div><label>Email</label><input id="email" type="email" placeholder="you@julinemart.com"></div>
      <div><label>Password</label><input id="password" type="password" placeholder="Password"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btn-login" class="btn primary" type="button">Log in</button>
      <a href="staff.html" class="btn" style="text-decoration:none">Go to Staff</a>
    </div>
    <p id="auth-msg" class="foot"></p>
  </section>

  <!-- Stats: Total Paid -->
  <section id="stats" class="card hidden">
    <div class="row" style="align-items:center">
      <div>
        <h3>Total Paid (choose dates or leave empty for all-time)</h3>
        <div class="row">
          <div><input type="date" id="s-from"></div>
          <div><input type="date" id="s-to"></div>
          <div style="flex:0 0 auto"><button id="btn-calc" class="btn" type="button">Calculate</button></div>
          <div style="flex:0 0 auto"><button id="btn-all" class="btn" type="button">All-time</button></div>
        </div>
      </div>
      <div id="paid-total" style="font-size:28px;font-weight:700">GBP 0.00</div>
    </div>
  </section>

  <!-- Admin dashboard -->
  <section id="admin" class="hidden">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3>All Requests</h3>
        <div class="row" style="margin-top:8px">
          <div><select id="f-status"><option value="">Status: All</option><option>Pending</option><option>Approved</option><option>Declined</option><option>Paid</option></select></div>
          <div><select id="f-kind"><option value="">Type: All</option><option value="petty_cash">Petty Cash</option><option value="reimbursement">Reimbursement</option></select></div>
          <div><input id="f-from" type="date"></div>
          <div><input id="f-to" type="date"></div>
          <div style="flex:0 0 auto"><button id="btn-filter" class="btn" type="button">Apply</button></div>
          <div style="flex:0 0 auto"><button id="btn-clear" class="btn" type="button">Clear</button></div>
        </div>
      </div>
      <div><button id="btn-export" class="btn primary" type="button">Export CSV</button></div>
    </div>

    <div class="card">
      <table id="admin-table">
        <thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Amount</th><th>Status</th><th>Action</th><th>Receipt</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o"
);

const el=id=>document.getElementById(id);
const S={who:el('whoami'),btnOut:el('btn-signout'),auth:el('auth'),authMsg:el('auth-msg'),
         loginBtn:el('btn-login'),noAdmin:null,admin:el('admin'),stats:el('stats'),
         tbody:document.querySelector('#admin-table tbody'), paidTotal:el('paid-total'),
         sFrom:el('s-from'), sTo:el('s-to'), btnCalc:el('btn-calc'), btnAll:el('btn-all')};

let user=null, LOAD_SEQ=0, INITIALIZED=false;

function show(sec){[S.auth,S.admin,S.stats].forEach(x=>x.classList.add('hidden'));sec.classList.remove('hidden');}
function setBusy(b,t){if(!b)return;b.dataset.prev=b.textContent;b.textContent=t;b.disabled=true;}
function clearBusy(b){if(!b)return;b.textContent=b.dataset.prev||b.textContent;b.disabled=false;}

async function init(){
  const {data:{session}}=await sb.auth.getSession();
  user=session?.user??null;
  if(!user){S.who.textContent='';S.btnOut.classList.add('hidden');show(S.auth);return;}
  S.who.textContent=user.email;S.btnOut.classList.remove('hidden');
  const prof=await sb.from('profiles').select('role').eq('user_id',user.id).maybeSingle();
  if((prof.data?.role||'staff')!=='admin'){show(S.auth);S.authMsg.textContent='Access denied (not admin).';return;}
  S.stats.classList.remove('hidden'); show(S.admin);
  load(); calcPaid();
}
function initOnce(){if(INITIALIZED) return; INITIALIZED=true; init();}
sb.auth.onAuthStateChange(()=>initOnce()); initOnce();
S.btnOut.onclick=async()=>{await sb.auth.signOut(); location.href='staff.html';};
S.loginBtn.onclick=async(e)=>{e.preventDefault();const email=el('email').value.trim(),pw=el('password').value.trim();
 if(!email||!pw){S.authMsg.textContent='Enter email & password.';return;}
 setBusy(S.loginBtn,'Logging in…');try{const {error}=await sb.auth.signInWithPassword({email,password:pw});
 if(error)throw error;location.reload();}catch(err){S.authMsg.textContent=err.message||String(err);}finally{clearBusy(S.loginBtn);}};

function pill(s){return `<span class="pill ${s}">${s}</span>`;}
function fmt(a,c){return `${c} ${Number(a).toFixed(2)}`;}
async function signedUrl(path){if(!path)return'';const {data}=await sb.storage.from('receipts').createSignedUrl(path,600);return data?.signedUrl||'';}

async function fetchRequests(filters={}){let q=sb.from('requests').select('*, profiles:user_id(full_name,user_id)').order('created_at',{ascending:false});
 if(filters.status)q=q.eq('status',filters.status); if(filters.kind)q=q.eq('kind',filters.kind);
 if(filters.from)q=q.gte('created_at',filters.from+'T00:00:00Z'); if(filters.to)q=q.lte('created_at',filters.to+'T23:59:59Z');
 const {data,error}=await q;if(error)throw error;return data;}

let LOAD_GUARD=0;
async function load(filters={}) {
  const seq=++LOAD_GUARD; S.tbody.innerHTML='<tr><td colspan="7">Loading…</td></tr>';
  try{
    const data=await fetchRequests(filters);
    if(seq!==LOAD_GUARD) return;
    S.tbody.innerHTML='';
    for(const r of data){
      const name=r.profiles?.full_name||(r.user_id||'').slice(0,8);
      const {data:notes}=await sb.from('request_notes').select('*').eq('request_id',r.id);
      const rec=(notes||[]).find(n=>n.note.startsWith('receipt:'));
      let link=''; if(rec){const url=await signedUrl(rec.note.replace('receipt:','')); if(url) link=`<a href="${url}" target="_blank" rel="noopener">View</a>`;}
      const selId=`sel-${r.id}`, cId=`com-${r.id}`, btnId=`btn-${r.id}`;
      const options=['Pending','Approved','Declined','Paid'].map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('');
      S.tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
          <td>${name}</td>
          <td>${r.kind.replace('_',' ')}</td>
          <td>${fmt(r.amount,r.currency)}</td>
          <td>${pill(r.status)}</td>
          <td>
            <div class="row" style="gap:6px;align-items:center">
              <div style="flex:1 1 120px"><select id="${selId}">${options}</select></div>
              <div style="flex:2 1 260px"><input id="${cId}" placeholder="Comment to staff (reason / note)"></div>
              <div style="flex:0 0 auto"><button id="${btnId}" class="btn">Update</button></div>
            </div>
          </td>
          <td>${link}</td>
        </tr>`);
      document.getElementById(btnId).onclick = ()=> updateStatus(r.id, document.getElementById(selId).value, document.getElementById(cId).value.trim());
    }
  }catch(err){if(seq!==LOAD_GUARD) return; S.tbody.innerHTML=`<tr><td colspan="7">${err.message}</td></tr>`;}
}

async function updateStatus(id, next, comment){
  try{
    if(next==='Paid'){
      const method = prompt('Payment method (e.g., Transfer, Cash, PayPal):','Transfer'); if(method===null) return;
      const reference = prompt('Reference / Transaction ID:','');
      await sb.from('payouts').insert({ request_id:id, paid_by:user.id, method, reference });
    }
    await sb.from('requests').update({ status: next }).eq('id', id);

    // Save admin comment (if provided)
    if(comment){
      await sb.from('request_notes').insert({ request_id:id, author_id:user.id, note: comment });
    }
    // Also save a standard status marker so we always have it in history
    await sb.from('request_notes').insert({ request_id:id, author_id:user.id, note:`Status -> ${next}` });

    load(readFilters()); calcPaid();
  }catch(err){ alert(err.message||String(err)); }
}

function readFilters(){ return {
  status: el('f-status').value || null,
  kind:   el('f-kind').value   || null,
  from:   el('f-from').value   || null,
  to:     el('f-to').value     || null
};}
el('btn-filter').onclick=()=> load(readFilters());
el('btn-clear').onclick=()=>{ el('f-status').value=''; el('f-kind').value=''; el('f-from').value=''; el('f-to').value=''; load({}); };

/* Export CSV */
el('btn-export').onclick=async()=>{const {data,error}=await sb.from('requests').select('*').order('created_at',{ascending:false});
 if(error){alert(error.message);return;}const rows=[['created_at','user_id','kind','amount','currency','needed_by','status','updated_at','id']];
 data.forEach(r=>rows.push([r.created_at,r.user_id,r.kind,r.amount,r.currency,r.needed_by||'',r.status,r.updated_at,r.id]));
 const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
 const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');
 a.href=url;a.download='julinemart_requests.csv';a.click();URL.revokeObjectURL(url);};

/* Stats: Total Paid */
async function calcPaid(){
  const from=el('s-from').value? el('s-from').value+'T00:00:00Z' : null;
  const to=el('s-to').value? el('s-to').value+'T23:59:59Z' : null;
  let q=sb.from('requests').select('amount').eq('status','Paid');
  if(from) q=q.gte('created_at',from);
  if(to) q=q.lte('created_at',to);
  const {data,error}=await q;
  if(error){ S.paidTotal.textContent='Error'; return; }
  const sum=(data||[]).reduce((acc,r)=> acc + Number(r.amount||0), 0);
  S.paidTotal.textContent = `GBP ${sum.toFixed(2)}`;
}
el('btn-calc').onclick=()=> calcPaid();
el('btn-all').onclick=()=>{ el('s-from').value=''; el('s-to').value=''; calcPaid(); };
</script>
</body>
</html>
