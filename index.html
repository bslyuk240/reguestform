<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Petty Cash & Reimbursements</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f6f7f9}
  header{background:#111;color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:16px;margin:0}
  main{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e6e8eb;border-radius:10px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  label{font-size:12px;color:#333;display:block;margin-bottom:6px}
  input,select,textarea,button{width:100%;padding:10px;border:1px solid #d8dbe0;border-radius:8px;font:inherit}
  textarea{min-height:90px}
  button{cursor:pointer}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
  .Pending{background:#fff3cd;border:1px solid #ffe69c}
  .Approved{background:#d1e7dd;border:1px solid #a3cfbb}
  .Declined{background:#f8d7da;border:1px solid #f1aeb5}
  .Paid{background:#cff4fc;border:1px solid #9eeaf9}
  nav{display:flex;gap:8px;margin-bottom:12px}
  nav button{flex:0 0 auto}
  .hidden{display:none}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .right{float:right}
  small.mono{font-family:ui-monospace,Menlo,Consolas,monospace;color:#6b7280}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
</style>
</head>
<body>
<header>
  <h1>Petty Cash & Reimbursements</h1>
  <div id="auth-area">
    <span id="whoami"></span>
    <button id="btn-signin">Sign in</button>
    <button id="btn-signout" class="hidden">Sign out</button>
  </div>
</header>

<main>
  <nav>
    <button id="tab-new">New Request</button>
    <button id="tab-mine">My Requests</button>
    <button id="tab-admin" class="hidden">Admin</button>
  </nav>

  <!-- Sign-in form -->
  <div class="card" id="signin-card" class="hidden">
    <h3>Sign in</h3>
    <p>Enter your email to receive a magic link.</p>
    <div class="row">
      <div><label>Email</label><input type="email" id="email" placeholder="you@company.com"></div>
    </div>
    <button id="send-link">Send magic link</button>
    <p id="signin-msg"></p>
  </div>

  <!-- New Request -->
  <section id="page-new" class="card hidden">
    <h3>New Request</h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="kind">
          <option value="petty_cash">Petty Cash (advance)</option>
          <option value="reimbursement">Reimbursement (pay me back)</option>
        </select>
      </div>
      <div>
        <label>Amount</label>
        <input type="number" step="0.01" id="amount" placeholder="0.00">
      </div>
      <div>
        <label>Currency</label>
        <select id="currency">
          <option>GBP</option><option>NGN</option><option>USD</option><option>EUR</option>
        </select>
      </div>
      <div>
        <label>Needed by (optional)</label>
        <input type="date" id="needed_by">
      </div>
    </div>
    <label>Description / Purpose</label>
    <textarea id="description" placeholder="What is this for?"></textarea>

    <label>Receipt / Supporting document (optional, PNG/JPG/PDF)</label>
    <input type="file" id="receipt" accept=".png,.jpg,.jpeg,.pdf">

    <div class="actions">
      <button id="submit-request">Submit</button>
    </div>
    <p id="new-msg"></p>
  </section>

  <!-- My Requests -->
  <section id="page-mine" class="card hidden">
    <h3>My Requests</h3>
    <table class="table" id="mine-table">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th><th>Receipt</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Admin -->
  <section id="page-admin" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Admin — All Requests</h3>
      <button id="btn-export">Export CSV</button>
    </div>
    <table class="table" id="admin-table">
      <thead>
        <tr>
          <th>Date</th><th>Staff</th><th>Type</th><th>Amount</th><th>Status</th><th>Actions</th><th>Receipt</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = (id)=>document.getElementById(id);
const authArea = document.getElementById('auth-area');

const tabNew = el('tab-new');
const tabMine = el('tab-mine');
const tabAdmin = el('tab-admin');

const pageNew = el('page-new');
const pageMine = el('page-mine');
const pageAdmin = el('page-admin');
const signinCard = el('signin-card');

const whoami = el('whoami');
const btnSignin = el('btn-signin');
const btnSignout = el('btn-signout');

let currentUser = null;
let currentProfile = null;

function showOnly(section){
  [signinCard,pageNew,pageMine,pageAdmin].forEach(s=>s.classList.add('hidden'));
  if(section) section.classList.remove('hidden');
}
function setTabs(){
  tabAdmin.classList.toggle('hidden', !(currentProfile && currentProfile.role==='admin'));
}

btnSignin.onclick = ()=> showOnly(signinCard);
btnSignout.onclick = async ()=>{
  await sb.auth.signOut();
  location.reload();
};

el('send-link').onclick = async ()=>{
  const email = el('email').value.trim();
  if(!email) return el('signin-msg').textContent = "Enter an email.";
  const { error } = await sb.auth.signInWithOtp({ email, options:{emailRedirectTo: window.location.origin} });
  el('signin-msg').textContent = error ? error.message : "Check your email for a sign-in link.";
};

tabNew.onclick = ()=> showOnly(pageNew);
tabMine.onclick = ()=> { showOnly(pageMine); loadMine(); };
tabAdmin.onclick = ()=> { showOnly(pageAdmin); loadAdmin(); };

async function loadProfile(uid){
  const { data, error } = await sb.from('profiles').select('*').eq('user_id', uid).single();
  if(error && error.code === 'PGRST116'){ // no row
    // create minimal profile
    const { data:ins } = await sb.from('profiles').insert({ user_id: uid, role: 'staff' }).select().single();
    return ins;
  }
  return data;
}

async function init(){
  const { data: { session } } = await sb.auth.getSession();
  currentUser = session ? session.user : null;

  if(currentUser){
    whoami.textContent = currentUser.email;
    btnSignin.classList.add('hidden');
    btnSignout.classList.remove('hidden');
    currentProfile = await loadProfile(currentUser.id);
    setTabs();
    showOnly(pageNew);
  } else {
    whoami.textContent = "";
    btnSignin.classList.remove('hidden');
    btnSignout.classList.add('hidden');
    showOnly(signinCard);
  }
}
sb.auth.onAuthStateChange((_e,session)=>{ currentUser = session?.user || null; init(); });

async function uploadReceipt(file){
  if(!file || !currentUser) return null;
  const ext = file.name.split('.').pop().toLowerCase();
  const path = `receipts/${currentUser.id}/${crypto.randomUUID()}.${ext}`;
  const { data, error } = await sb.storage.from('receipts').upload(path, file, { upsert:false, contentType: file.type });
  if(error){ console.error(error); return null; }
  return data.path; // store path; use signed URL to view
}

async function submitRequest(){
  const kind = el('kind').value;
  const amount = parseFloat(el('amount').value || '0');
  const currency = el('currency').value;
  const needed_by = el('needed_by').value || null;
  const description = el('description').value.trim();
  const file = el('receipt').files[0];

  if(!description || !amount){ el('new-msg').textContent = "Please enter description and amount."; return; }

  let receiptPath = null;
  if(file) receiptPath = await uploadReceipt(file);

  const { data, error } = await sb.from('requests').insert({
    user_id: currentUser.id, kind, amount, currency, needed_by, description
  }).select().single();

  if(error){ el('new-msg').textContent = error.message; return; }
  el('new-msg').textContent = "Request submitted.";
  // optional: attach a note with receipt path
  if(receiptPath){
    await sb.from('request_notes').insert({ request_id: data.id, author_id: currentUser.id, note: `receipt:${receiptPath}` });
  }
  el('amount').value = ""; el('description').value = ""; el('receipt').value = ""; el('needed_by').value = "";
}

el('submit-request').onclick = submitRequest;

function fmtMoney(a,c){ return `${c} ${Number(a).toFixed(2)}`; }
function pill(status){ return `<span class="pill ${status}">${status}</span>`; }

async function signedUrl(path){
  if(!path) return '';
  const { data, error } = await sb.storage.from('receipts').createSignedUrl(path, 60*10); // 10 min
  return error ? '' : data.signedUrl;
}

async function loadMine(){
  const tbody = document.querySelector('#mine-table tbody');
  tbody.innerHTML = '<tr><td colspan="5">Loading…</td></tr>';
  const { data, error } = await sb.from('requests').select('*').order('created_at',{ascending:false});
  if(error){ tbody.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`; return; }
  tbody.innerHTML = '';
  for(const r of data){
    // find receipt note
    const { data:notes } = await sb.from('request_notes').select('*').eq('request_id', r.id);
    const receiptNote = (notes||[]).find(n=>n.note.startsWith('receipt:'));
    let link = '';
    if(receiptNote){
      const path = receiptNote.note.replace('receipt:','');
      const url = await signedUrl(path);
      if(url) link = `<a href="${url}" target="_blank">View</a>`;
    }
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${r.kind.replace('_',' ')}</td>
        <td>${fmtMoney(r.amount,r.currency)}</td>
        <td>${pill(r.status)}</td>
        <td>${link}</td>
      </tr>
    `);
  }
}

async function loadAdmin(){
  const tbody = document.querySelector('#admin-table tbody');
  tbody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  const { data, error } = await sb
    .from('requests')
    .select('*, profiles: user_id (full_name, role, user_id)')
    .order('created_at',{ascending:false});
  if(error){ tbody.innerHTML = `<tr><td colspan="7">${error.message}</td></tr>`; return; }
  tbody.innerHTML = '';
  for(const r of data){
    const name = r.profiles?.full_name || r.user_id?.slice(0,8);
    // fetch receipt link
    const { data:notes } = await sb.from('request_notes').select('*').eq('request_id', r.id);
    const receiptNote = (notes||[]).find(n=>n.note.startsWith('receipt:'));
    let link = '';
    if(receiptNote){
      const path = receiptNote.note.replace('receipt:','');
      const url = await signedUrl(path);
      if(url) link = `<a href="${url}" target="_blank">View</a>`;
    }
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${name}</td>
        <td>${r.kind.replace('_',' ')}</td>
        <td>${fmtMoney(r.amount,r.currency)}</td>
        <td>${pill(r.status)}</td>
        <td class="actions">
          <button data-act="approve" data-id="${r.id}">Approve</button>
          <button data-act="decline" data-id="${r.id}">Decline</button>
          <button data-act="pay" data-id="${r.id}">Mark Paid</button>
        </td>
        <td>${link}</td>
      </tr>
    `);
  }
  tbody.querySelectorAll('button').forEach(b=> b.onclick = onAdminAction);
}

async function onAdminAction(e){
  if(!(currentProfile && currentProfile.role==='admin')) return;
  const id = e.target.dataset.id;
  const act = e.target.dataset.act;
  if(act==='approve' || act==='decline'){
    const status = act==='approve' ? 'Approved' : 'Declined';
    await sb.from('requests').update({ status }).eq('id', id);
    await sb.from('request_notes').insert({ request_id:id, author_id: currentUser.id, note:`Status -> ${status}` });
    loadAdmin();
  } else if(act==='pay'){
    const method = prompt('Payment method (e.g., Cash, Transfer, PayPal):','Transfer');
    if(method===null) return;
    const reference = prompt('Reference / Transaction ID:','');
    await sb.from('payouts').insert({ request_id: id, paid_by: currentUser.id, method, reference });
    await sb.from('requests').update({ status:'Paid' }).eq('id', id);
    await sb.from('request_notes').insert({ request_id:id, author_id: currentUser.id, note:`Status -> Paid (${method} ${reference||''})` });
    loadAdmin();
  }
}

el('btn-export').onclick = async ()=>{
  if(!(currentProfile && currentProfile.role==='admin')) return;
  const { data, error } = await sb.from('requests').select('*').order('created_at',{ascending:false});
  if(error){ alert(error.message); return; }
  const rows = [
    ['created_at','user_id','kind','amount','currency','needed_by','status','updated_at','id']
  ];
  data.forEach(r=>{
    rows.push([r.created_at,r.user_id,r.kind,r.amount,r.currency,r.needed_by||'',r.status,r.updated_at,r.id]);
  });
  const csv = rows.map(r=> r.map(x => `"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'requests_export.csv'; a.click();
  URL.revokeObjectURL(url);
};

// Kick off
init();
</script>
</body>
</html>
