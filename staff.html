<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JulineMart • Staff</title>
<link rel="icon" href="logo.png">
<style>
  body{font-family:system-ui;background:#f6f8fa;margin:0}
  header{background:#0E141B;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:8px;align-items:center}
  .brand img{width:28px;height:28px;border-radius:6px}
  .card{background:#fff;padding:16px;margin:20px auto;max-width:500px;border:1px solid #ddd;border-radius:12px}
  input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button{cursor:pointer;background:#08A045;color:#fff;border:none}
  button.secondary{background:#ccc;color:#000}
  .hidden{display:none}
  .pill{padding:2px 8px;border-radius:8px;font-size:12px}
  .Pending{background:#fff3cd}
  .Approved{background:#d1e7dd}
  .Declined{background:#f8d7da}
  .Paid{background:#cff4fc}
</style>
</head>
<body>
<header>
  <div class="brand"><img src="logo.png"><b>JulineMart Staff</b></div>
  <div><span id="whoami"></span> <button id="btn-signout" class="hidden">Sign out</button></div>
</header>

<main>
  <!-- LOGIN/REGISTER -->
  <div id="auth-card" class="card">
    <h3>Staff Login</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="btn-login">Log in</button>
    <button id="btn-register" class="secondary">Register</button>
    <p id="auth-msg"></p>
  </div>

  <!-- NEW REQUEST -->
  <div id="new-card" class="card hidden">
    <h3>New Request</h3>
    <select id="kind">
      <option value="petty_cash">Petty Cash</option>
      <option value="reimbursement">Reimbursement</option>
    </select>
    <input type="number" id="amount" placeholder="Amount">
    <select id="currency"><option>GBP</option><option>NGN</option><option>USD</option></select>
    <input type="date" id="needed_by">
    <textarea id="description" placeholder="Description"></textarea>
    <button id="btn-submit">Submit Request</button>
    <p id="new-msg"></p>
  </div>

  <!-- MY REQUESTS -->
  <div id="mine-card" class="card hidden">
    <h3>My Requests</h3>
    <table border="1" width="100%">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
      <tbody id="mine-body"></tbody>
    </table>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o"
);

const el = id => document.getElementById(id);
const authCard = el("auth-card"), newCard = el("new-card"), mineCard = el("mine-card");
let currentUser = null;

function showAuth(){authCard.classList.remove("hidden"); newCard.classList.add("hidden"); mineCard.classList.add("hidden");}
function showApp(){authCard.classList.add("hidden"); newCard.classList.remove("hidden"); mineCard.classList.remove("hidden");}

async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  currentUser = session?.user ?? null;
  console.log("Session on init:", session);
  if(currentUser){
    el("whoami").textContent = currentUser.email;
    el("btn-signout").classList.remove("hidden");
    showApp(); loadMine();
  }else{
    el("whoami").textContent = "";
    el("btn-signout").classList.add("hidden");
    showAuth();
  }
}
sb.auth.onAuthStateChange((_event, session)=>{console.log("Auth state:",_event,session); init();});

el("btn-signout").onclick = async()=>{ await sb.auth.signOut(); location.reload(); };

el("btn-register").onclick = async()=>{
  const email = el("email").value, pw = el("password").value;
  el("auth-msg").textContent="Registering…";
  const { data, error } = await sb.auth.signUp({ email, password: pw });
  console.log("Register result:", data, error);
  if(error){ el("auth-msg").textContent=error.message; return; }
  if(data.session){ location.reload(); } else { el("auth-msg").textContent="Registered! Please log in."; }
};

el("btn-login").onclick = async()=>{
  const email = el("email").value, pw = el("password").value;
  el("auth-msg").textContent="Logging in…";
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
  console.log("Login result:", data, error);
  if(error){ el("auth-msg").textContent=error.message; return; }
  location.reload();
};

el("btn-submit").onclick = async()=>{
  const kind=el("kind").value, amount=parseFloat(el("amount").value||0), currency=el("currency").value;
  const desc=el("description").value;
  if(!amount||!desc){el("new-msg").textContent="Fill all fields";return;}
  const { data,error } = await sb.from("requests").insert({ user_id: currentUser.id, kind, amount, currency, description: desc }).select().single();
  console.log("Insert request:", data, error);
  if(error){el("new-msg").textContent=error.message;return;}
  el("new-msg").textContent="Submitted!"; loadMine();
};

async function loadMine(){
  const { data, error } = await sb.from("requests").select("*").eq("user_id", currentUser.id).order("created_at",{ascending:false});
  console.log("Load mine:", data, error);
  const body=el("mine-body"); body.innerHTML="";
  if(error){ body.innerHTML=`<tr><td colspan=4>${error.message}</td></tr>`; return; }
  data.forEach(r=>{
    body.innerHTML += `<tr><td>${new Date(r.created_at).toLocaleDateString()}</td><td>${r.kind}</td><td>${r.amount} ${r.currency}</td><td><span class="pill ${r.status}">${r.status}</span></td></tr>`;
  });
}
init();
</script>
</body>
</html>
