<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JulineMart • Staff</title>
<link rel="icon" href="logo.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0E141B">
<style>
  :root{--jm-primary:#08A045; --jm-dark:#0E141B; --jm-bg:#F6F8FA; --jm-border:#E7EAEE;
        --pill-pending:#fff3cd; --pill-pending-b:#ffe69c; --pill-approved:#d1e7dd; --pill-approved-b:#a3cfbb;
        --pill-declined:#f8d7da; --pill-declined-b:#f1aeb5; --pill-paid:#cff4fc; --pill-paid-b:#9eeaf9;
        --pill-cancel:#ececec; --pill-cancel-b:#d9d9d9;}
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--jm-bg);color:#1f2937}
  header{background:var(--jm-dark);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
  .brand h1{font-size:16px;margin:0}
  .sub{opacity:.75;font-size:12px;margin-top:2px}
  .btn{cursor:pointer;padding:9px 12px;border-radius:9px;border:1px solid var(--jm-border);background:#fff}
  .btn.primary{background:var(--jm-primary);color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--jm-border);border-radius:12px;padding:16px;margin-bottom:16px}
  label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border:1px solid #d8dbe0;border-radius:10px;font:inherit}
  textarea{min-height:90px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>*{flex:1 1 240px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid transparent}
  .Pending{background:var(--pill-pending);border-color:var(--pill-pending-b)}
  .Approved{background:var(--pill-approved);border-color:var(--pill-approved-b)}
  .Declined{background:var(--pill-declined);border-color:var(--pill-declined-b)}
  .Paid{background:var(--pill-paid);border-color:var(--pill-paid-b)}
  .Cancelled{background:var(--pill-cancel);border-color:var(--pill-cancel-b)}
  a.switch{color:var(--jm-primary);text-decoration:none}
  .foot-note{font-size:12px;color:#6b7280}
  .hidden{display:none}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .thumbs a{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;text-decoration:none;color:#111}
  .thumbs img{width:28px;height:28px;border-radius:6px;object-fit:cover}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="JM">
    <div>
      <h1>JulineMart • Staff</h1>
      <div class="sub">Petty Cash & Reimbursements</div>
    </div>
  </div>
  <div>
    <span id="whoami"></span>
    <button id="btn-signout" class="btn hidden" type="button">Sign out</button>
  </div>
</header>

<main>
  <!-- LOGIN / REGISTER -->
  <div class="card" id="signin-card">
    <h3>Staff Access</h3>
    <div class="row">
      <div><label>Email</label><input type="email" id="email" placeholder="you@julinemart.com" autocomplete="username"></div>
      <div><label>Password</label><input type="password" id="password" placeholder="Enter password" autocomplete="current-password"></div>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btn-login" class="btn primary" type="button">Log in</button>
      <button id="btn-register" class="btn" type="button">Register</button>
    </div>
    <p id="signin-msg" class="foot-note"></p>
    <p class="foot-note">Admin? <a class="switch" href="admin.html">Go to Admin</a></p>
  </div>

  <!-- NEW REQUEST -->
  <section class="card hidden" id="page-new">
    <h3>New Request</h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="kind">
          <option value="petty_cash">Petty Cash (advance)</option>
          <option value="reimbursement">Reimbursement (pay me back)</option>
        </select>
      </div>
      <div><label>Amount</label><input type="number" step="0.01" id="amount" placeholder="0.00"></div>
      <div><label>Currency</label>
        <select id="currency"><option>GBP</option><option>NGN</option><option>USD</option><option>EUR</option></select>
      </div>
      <div><label>Needed by (optional)</label><input type="date" id="needed_by"></div>
    </div>
    <label>Description / Purpose</label>
    <textarea id="description" placeholder="What is this for?"></textarea>

    <!-- multiple receipts -->
    <label>Receipts / Supporting docs (PNG/JPG/PDF — you can select multiple)</label>
    <input type="file" id="receipts" accept=".png,.jpg,.jpeg,.pdf" multiple>
    <div id="receipt-preview" class="thumbs"></div>

    <div style="margin-top:10px"><button id="submit-request" class="btn primary" type="button">Submit</button></div>
    <p id="new-msg" class="foot-note"></p>
  </section>

  <!-- MY REQUESTS (filters + list + edit/cancel) -->
  <section class="card hidden" id="page-mine">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>My Requests</h3>
      <div class="toolbar">
        <select id="f-status">
          <option value="">Status: All</option>
          <option>Pending</option><option>Approved</option><option>Declined</option><option>Paid</option><option>Cancelled</option>
        </select>
        <input id="f-from" type="date" aria-label="From date">
        <input id="f-to" type="date" aria-label="To date">
        <input id="f-q" type="search" placeholder="Search description…" style="min-width:200px">
        <button id="btn-apply" class="btn" type="button">Apply</button>
        <button id="btn-clear" class="btn" type="button">Clear</button>
        <button id="btn-refresh" class="btn" type="button">Refresh</button>
      </div>
    </div>
    <table id="mine-table">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th><th>Receipt(s)</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Paid History -->
  <section class="card hidden" id="page-paid">
    <h3>Paid History (by month)</h3>
    <div style="overflow:auto">
      <table id="paid-table">
        <thead><tr><th>Month</th><th>Total Paid</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* Supabase (your project) */
const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o"
);

const el = id => document.getElementById(id);
const signinCard = el('signin-card'), pageNew = el('page-new'), pageMine = el('page-mine'), pagePaid = el('page-paid');
const whoami = el('whoami'), btnSignout = el('btn-signout');
let currentUser = null;

/* guards */
let INITIALIZED = false;
let LOAD_SEQ = 0;

function show(section){ [signinCard,pageNew,pageMine,pagePaid].forEach(s=>s.classList.add('hidden')); section.classList.remove('hidden'); }
btnSignout.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

function setBusy(button, txt){ if(!button) return; button.dataset.prev = button.textContent; button.textContent = txt; button.disabled = true; }
function clearBusy(button){ if(!button) return; button.disabled = false; button.textContent = button.dataset.prev || button.textContent; }

/* ====== INIT + Realtime live notifications ====== */
async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  currentUser = session?.user ?? null;

  if(currentUser){
    whoami.textContent = currentUser.email;
    btnSignout.classList.remove('hidden');
    show(pageNew);
    loadMine();
    loadPaidHistory();
    enableRealtime();
    // Ask for notification permission (only once per session)
    if (Notification && Notification.permission === 'default') {
      try { await Notification.requestPermission(); } catch {}
    }
  }else{
    whoami.textContent = "";
    btnSignout.classList.add('hidden');
    show(signinCard);
  }
}
function initOnce(){ if (INITIALIZED) return; INITIALIZED = true; init(); }
sb.auth.onAuthStateChange(()=>initOnce());
initOnce();

/* Realtime notifications: alert status changes for THIS user's requests */
let rtChannel = null;
function enableRealtime(){
  try{
    if(rtChannel) sb.removeChannel(rtChannel);
    rtChannel = sb.channel('req-status-'+currentUser.id)
      .on('postgres_changes',
          { event: '*', schema: 'public', table: 'requests', filter: `user_id=eq.${currentUser.id}` },
          payload => {
            if(payload.eventType === 'UPDATE'){
              const newStatus = payload.new.status;
              notify(`Request ${payload.new.id} is now ${newStatus}`);
              loadMine(); loadPaidHistory();
            }
            if(payload.eventType === 'INSERT'){
              notify(`New request submitted.`);
              loadMine();
            }
          })
      .subscribe();
  }catch(e){ console.warn('Realtime subscribe failed', e); }
}
function notify(message){
  try{
    if(!('Notification' in window)) return;
    if(Notification.permission === 'granted'){
      new Notification('JulineMart', { body: message, icon: 'logo.png' });
    }
  }catch{}
}

/* ====== AUTH HANDLERS ====== */
el('btn-login').onclick = async (e)=>{
  e.preventDefault();
  const btn = e.currentTarget;
  const email = el('email').value.trim();
  const password = el('password').value.trim();
  if(!email || !password){ el('signin-msg').textContent = "Enter email & password."; return; }
  setBusy(btn, "Logging in…");
  try{
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    location.reload();
  }catch(err){ el('signin-msg').textContent = err.message || String(err); }
  finally{ clearBusy(btn); }
};

el('btn-register').onclick = async (e)=>{
  e.preventDefault();
  const btn = e.currentTarget;
  const email = el('email').value.trim();
  const password = el('password').value.trim();
  if(!email || !password){ el('signin-msg').textContent = "Enter email & password."; return; }
  setBusy(btn, "Registering…");
  try{
    const { data, error } = await sb.auth.signUp({ email, password });
    if(error) throw error;
    if(data && data.session){ location.reload(); }
    else { el('signin-msg').textContent = "Registered! Please log in."; }
  }catch(err){ el('signin-msg').textContent = err.message || String(err); }
  finally{ clearBusy(btn); }
};

/* ====== RECEIPTS PREVIEW & UPLOAD (multiple) ====== */
const fileIcon = type => type.includes('pdf') ? '📄' : '';
el('receipts').addEventListener('change', () => {
  const box = el('receipt-preview'); box.innerHTML = '';
  [...el('receipts').files].forEach(f=>{
    const item = document.createElement('a'); item.href='#';
    if(f.type.startsWith('image/')){ const img = document.createElement('img'); img.src = URL.createObjectURL(f); item.appendChild(img); item.append(' '+f.name); }
    else { item.textContent = `${fileIcon(f.type)} ${f.name}`; }
    box.appendChild(item);
  });
});

async function uploadOne(file){
  const ext=(file.name.split('.').pop()||'bin').toLowerCase();
  const path=`receipts/${currentUser.id}/${crypto.randomUUID()}.${ext}`;
  const { data, error } = await sb.storage.from('receipts').upload(path, file, { upsert:false, contentType:file.type||'application/octet-stream' });
  if(error){ console.warn('upload error', error); return null; }
  return data.path;
}

/* ====== SUBMIT NEW REQUEST ====== */
el('submit-request').onclick = async (e)=>{
  e.preventDefault();
  try{
    if(!currentUser){ el('new-msg').textContent = "Please log in first."; return; }
    const kind = el('kind').value;
    const amount = parseFloat(el('amount').value || '0');
    const currency = el('currency').value;
    const needed_by = el('needed_by').value || null;
    const description = el('description').value.trim();
    if(!description || !(amount > 0)){ el('new-msg').textContent = "Fill description and amount."; return; }

    // Insert request
    const { data: req, error } = await sb.from('requests')
      .insert({ user_id: currentUser.id, kind, amount, currency, needed_by, description })
      .select().single();
    if(error){ el('new-msg').textContent = error.message; return; }

    // Upload all receipts -> save as request_notes (receipt:<path>)
    const files = [...el('receipts').files];
    for (const f of files){
      const p = await uploadOne(f);
      if(p) await sb.from('request_notes').insert({ request_id: req.id, author_id: currentUser.id, note:`receipt:${p}` });
    }

    el('new-msg').textContent = "Request submitted.";
    el('amount').value=""; el('description').value=""; el('needed_by').value=""; el('receipts').value=""; el('receipt-preview').innerHTML='';
    loadMine(); loadPaidHistory();
  }catch(err){ el('new-msg').textContent = err.message || String(err); }
};

/* ====== LIST + FILTERS + EDIT/CANCEL ====== */
function pill(s){ return `<span class="pill ${s}">${s}</span>`; }
function fmt(a,c){ return `${c} ${Number(a).toFixed(2)}`; }
async function signedUrl(path){ if(!path) return ''; const { data, error } = await sb.storage.from('receipts').createSignedUrl(path,600); return error?'':data.signedUrl; }

el('btn-apply').onclick = ()=> loadMine(readFilters());
el('btn-clear').onclick = ()=>{ el('f-status').value=''; el('f-from').value=''; el('f-to').value=''; el('f-q').value=''; loadMine({}); };
el('btn-refresh').onclick = ()=> loadMine(readFilters());
function readFilters(){ return { status:el('f-status').value||null, from:el('f-from').value||null, to:el('f-to').value||null, q:el('f-q').value.trim()||null }; }

async function loadMine(filters={}){
  const seq = ++LOAD_SEQ;
  const tbody=document.querySelector('#mine-table tbody');
  tbody.innerHTML='<tr><td colspan="6">Loading…</td></tr>';

  let q = sb.from('requests').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:false});
  if(filters.status) q=q.eq('status',filters.status);
  if(filters.from) q=q.gte('created_at',filters.from+'T00:00:00Z');
  if(filters.to)   q=q.lte('created_at',filters.to+'T23:59:59Z');
  if(filters.q)    q=q.ilike('description', `%${filters.q}%`);

  const { data, error } = await q;
  if(seq !== LOAD_SEQ) return; // stale
  if(error){ tbody.innerHTML = `<tr><td colspan="6">${error.message}</td></tr>`; return; }

  tbody.innerHTML='';
  for (const r of data){
    // receipts for this request
    const { data: notes } = await sb.from('request_notes').select('*').eq('request_id', r.id);
    const recs = (notes||[]).filter(n=>n.note.startsWith('receipt:'));
    let links='';
    for (const rec of recs){
      const url = await signedUrl(rec.note.replace('receipt:',''));
      if(url){
        const isPdf = url.toLowerCase().includes('.pdf');
        links += `<a href="${url}" target="_blank" rel="noopener">${isPdf?'📄':'🖼️'} receipt</a> `;
      }
    }

    // actions for Pending
    let actions = '';
    if(r.status === 'Pending'){
      actions = `
        <button class="btn" data-edit="${r.id}">Edit</button>
        <button class="btn" data-cancel="${r.id}">Cancel</button>
      `;
    }

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${r.kind.replace('_',' ')}</td>
        <td>${fmt(r.amount,r.currency)}</td>
        <td>${pill(r.status)}</td>
        <td>${links || '—'}</td>
        <td>${actions}</td>
      </tr>
    `);
  }

  // wire actions
  document.querySelectorAll('[data-edit]').forEach(b => b.onclick = () => editRequest(b.dataset.edit));
  document.querySelectorAll('[data-cancel]').forEach(b => b.onclick = () => cancelRequest(b.dataset.cancel));
}

async function editRequest(id){
  // simple prompts (keep UI minimal)
  const amount = prompt('New amount (leave blank to keep)', '');
  const description = prompt('New description (leave blank to keep)', '');
  const needed_by = prompt('New needed-by date (YYYY-MM-DD) (blank to keep)', '');

  const patch = {};
  if(amount && !isNaN(parseFloat(amount))) patch.amount = parseFloat(amount);
  if(description && description.trim()) patch.description = description.trim();
  if(needed_by && /^\d{4}-\d{2}-\d{2}$/.test(needed_by)) patch.needed_by = needed_by;

  if(Object.keys(patch).length === 0) return;

  const { error } = await sb.from('requests')
    .update(patch)
    .eq('id', id)
    .eq('user_id', currentUser.id)
    .eq('status', 'Pending');   // only pending can be edited
  if(error){ alert(error.message); return; }
  await sb.from('request_notes').insert({ request_id:id, author_id: currentUser.id, note:'Edited by staff' });
  loadMine(readFilters());
}

async function cancelRequest(id){
  if(!confirm('Cancel this request? This cannot be undone.')) return;
  const { error } = await sb.from('requests')
    .update({ status:'Cancelled' })
    .eq('id', id)
    .eq('user_id', currentUser.id)
    .eq('status', 'Pending');
  if(error){ alert(error.message); return; }
  await sb.from('request_notes').insert({ request_id:id, author_id: currentUser.id, note:'Cancelled by staff' });
  loadMine(readFilters());
}

/* ====== PAID HISTORY (sum by month for this user) ====== */
async function loadPaidHistory(){
  const tbody = document.querySelector('#paid-table tbody');
  tbody.innerHTML = '<tr><td colspan="2">Loading…</td></tr>';
  const { data, error } = await sb
    .from('requests')
    .select('amount, currency, created_at')
    .eq('user_id', currentUser.id)
    .eq('status', 'Paid')
    .order('created_at',{ascending:false});
  if(error){ tbody.innerHTML = `<tr><td colspan="2">${error.message}</td></tr>`; return; }

  // group by YYYY-MM
  const groups = {};
  for(const r of data){
    const d = new Date(r.created_at);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    groups[ym] = (groups[ym] || 0) + Number(r.amount || 0);
  }
  const rows = Object.entries(groups).sort((a,b)=> a[0]<b[0]?1:-1);
  tbody.innerHTML = rows.length? '' : '<tr><td colspan="2">No paid items yet.</td></tr>';
  for(const [ym, total] of rows){
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${ym}</td><td>GBP ${total.toFixed(2)}</td></tr>`);
  }

  // show card when logged in
  pagePaid.classList.remove('hidden');
}

/* ====== PWA service worker (installable) ====== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}
</script>
</body>
</html>
