<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JulineMart • Staff</title>
<link rel="icon" href="logo.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0E141B">
<style>
  :root{
    --jm-primary:#08A045; --jm-dark:#0E141B; --jm-bg:#F6F8FA; --jm-border:#E7EAEE;
    --pill-pending:#f7c873; --pill-approved:#51c36a; --pill-declined:#e35a5a; --pill-paid:#34c0d3;
  }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{padding:18px 20px}
  header h1{margin:0;font-size:36px;font-weight:800}
  main{max-width:1100px;margin:0 auto;padding:0 20px 48px}
  .card{margin-top:20px}
  /* My Requests table look like your mock */
  table{width:100%;border-collapse:separate;border-spacing:0 18px}
  thead th{font-size:34px;font-weight:800;padding:0 12px}
  tbody td{padding:10px 12px;border-top:2px dashed #333}
  tbody tr:last-child td{border-bottom:2px dashed #333}
  .status-pill{display:inline-block;padding:4px 12px;border-radius:12px;color:#fff;font-weight:700}
  .st-Pending{background:var(--pill-pending);color:#2f1d00}
  .st-Approved{background:var(--pill-approved)}
  .st-Declined{background:var(--pill-declined)}
  .st-Paid{background:var(--pill-paid)}
  .amount{font-weight:700}
  .comment-box{border:2px solid #000; border-radius:4px; padding:10px; min-height:36px; background:#fff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .toolbar input,.toolbar select{padding:8px 10px;font:inherit;border:1px solid #ddd;border-radius:8px}
  .btn{padding:9px 12px;border-radius:8px;border:1px solid #ddd;background:#f6f8fa;cursor:pointer}
  .btn.primary{background:var(--jm-primary);color:#fff;border-color:transparent}
  .meta{color:#6b7280;font-size:12px;margin-top:6px}
  /* Sign-in card simple */
  .auth{max-width:520px}
  .auth input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px}
  .auth .btns{display:flex;gap:8px;margin-top:10px}
  .hidden{display:none}
  /* Paid History card */
  .history-card{margin-top:24px;border-top:1px solid #eee;padding-top:8px}
  .history-card table{border-spacing:0 8px}
  .history-card thead th{font-size:16px}
  .history-card tbody td{border:0;padding:6px 0}
</style>
</head>
<body>
<header>
  <h1>Staff.html</h1>
</header>

<main>
  <!-- Sign in / Register -->
  <section id="signin" class="auth">
    <h3>Sign in</h3>
    <label>Email <input id="email" type="email" placeholder="you@julinemart.com" autocomplete="username"></label>
    <label>Password <input id="password" type="password" placeholder="Password" autocomplete="current-password"></label>
    <div class="btns">
      <button id="btn-login" class="btn primary" type="button">Log in</button>
      <button id="btn-register" class="btn" type="button">Register</button>
    </div>
    <div id="auth-msg" class="meta"></div>
    <div class="meta">Admin? <a href="admin.html">Go to Admin</a></div>
  </section>

  <!-- New request -->
  <section id="new" class="card hidden">
    <h3>New Request</h3>
    <div class="toolbar">
      <select id="kind">
        <option value="petty_cash">Petty Cash (advance)</option>
        <option value="reimbursement">Reimbursement (pay me back)</option>
      </select>
      <input id="amount" type="number" step="0.01" placeholder="Amount">
      <select id="currency"><option>GBP</option><option>NGN</option><option>USD</option><option>EUR</option></select>
      <input id="needed_by" type="date" placeholder="Needed by (optional)">
    </div>
    <textarea id="description" placeholder="What is this for?" style="width:100%;min-height:100px;padding:12px;border:1px solid #ddd;border-radius:10px"></textarea>
    <div class="meta" style="margin-top:6px">Attach receipts (PNG/JPG/PDF):</div>
    <input id="receipts" type="file" accept=".png,.jpg,.jpeg,.pdf" multiple>
    <div style="margin-top:10px"><button id="submit" class="btn primary" type="button">Submit</button></div>
    <div id="new-msg" class="meta"></div>
  </section>

  <!-- My Requests -->
  <section id="mine" class="card hidden">
    <h3>My Requests</h3>
    <div class="toolbar">
      <select id="f-status">
        <option value="">Status: All</option>
        <option>Pending</option><option>Approved</option><option>Declined</option><option>Paid</option><option>Cancelled</option>
      </select>
      <input id="f-from" type="date">
      <input id="f-to" type="date">
      <input id="f-q" type="search" placeholder="Search description…">
      <button id="btn-apply" class="btn" type="button">Apply</button>
      <button id="btn-clear" class="btn" type="button">Clear</button>
      <button id="btn-refresh" class="btn" type="button">Refresh</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Date</th>
          <th>status</th>
          <th>Amount</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="history-card">
      <h4>Paid History (by month)</h4>
      <table id="paid">
        <thead><tr><th>Month</th><th>Total Paid</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o"
);

const $ = id => document.getElementById(id);
const E = {
  signin: $('signin'), new: $('new'), mine: $('mine'),
  email: $('email'), pass: $('password'), authMsg: $('auth-msg'),
  kind: $('kind'), amount: $('amount'), currency: $('currency'), needed: $('needed_by'), desc: $('description'),
  receipts: $('receipts'), submit: $('submit'), newMsg: $('new-msg'),
  tbody: document.querySelector('#tbl tbody'),
  fStatus: $('f-status'), fFrom: $('f-from'), fTo: $('f-to'), fQ: $('f-q'),
  paidBody: document.querySelector('#paid tbody')
};

let USER=null, INIT=false, LOADSEQ=0;

function show(section){ [E.signin,E.new,E.mine].forEach(x=>x.classList.add('hidden')); section.classList.remove('hidden'); }

async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  USER = session?.user ?? null;
  if(USER){ show(E.new); E.mine.classList.remove('hidden'); loadMine(); loadPaid(); realtime(); }
  else{ show(E.signin); }
}
function once(){ if(INIT) return; INIT=true; init(); }
sb.auth.onAuthStateChange(()=>once()); once();

/* AUTH */
$('btn-login').onclick = async e=>{
  const email=E.email.value.trim(), pw=E.pass.value.trim();
  if(!email||!pw){E.authMsg.textContent='Enter email & password.';return;}
  $('btn-login').disabled=true; $('btn-login').textContent='Logging in…';
  const { error } = await sb.auth.signInWithPassword({ email, password:pw });
  $('btn-login').disabled=false; $('btn-login').textContent='Log in';
  if(error) E.authMsg.textContent = error.message; else location.reload();
};
$('btn-register').onclick = async e=>{
  const email=E.email.value.trim(), pw=E.pass.value.trim();
  if(!email||!pw){E.authMsg.textContent='Enter email & password.';return;}
  $('btn-register').disabled=true; $('btn-register').textContent='Registering…';
  const { data, error } = await sb.auth.signUp({ email, password:pw });
  $('btn-register').disabled=false; $('btn-register').textContent='Register';
  if(error) E.authMsg.textContent = error.message;
  else if(data.session) location.reload();
  else E.authMsg.textContent='Registered! Please log in.';
};

/* SUBMIT */
E.submit.onclick = async ()=>{
  if(!USER){E.newMsg.textContent='Please log in first.';return;}
  const amount=parseFloat(E.amount.value||0);
  const body={ user_id:USER.id, kind:E.kind.value, amount, currency:E.currency.value, needed_by:E.needed.value||null, description:E.desc.value.trim() };
  if(!(amount>0)||!body.description){E.newMsg.textContent='Fill amount and description.';return;}
  E.submit.disabled=true; E.submit.textContent='Submitting…';
  const { data:req, error } = await sb.from('requests').insert(body).select().single();
  if(error){E.newMsg.textContent=error.message;E.submit.disabled=false;E.submit.textContent='Submit';return;}
  // upload receipts -> save as notes
  for(const f of [...E.receipts.files]){
    const ext=(f.name.split('.').pop()||'bin').toLowerCase();
    const path=`receipts/${USER.id}/${crypto.randomUUID()}.${ext}`;
    await sb.storage.from('receipts').upload(path, f, { upsert:false });
    await sb.from('request_notes').insert({ request_id:req.id, author_id:USER.id, note:`receipt:${path}` });
  }
  E.newMsg.textContent='Request submitted.'; E.amount.value=''; E.desc.value=''; E.needed.value=''; E.receipts.value='';
  E.submit.disabled=false; E.submit.textContent='Submit';
  loadMine(); loadPaid();
};

/* LIST + FILTERS */
$('btn-apply').onclick = ()=> loadMine(readFilters());
$('btn-clear').onclick = ()=>{E.fStatus.value='';E.fFrom.value='';E.fTo.value='';E.fQ.value='';loadMine();}
$('btn-refresh').onclick = ()=> loadMine(readFilters());
function readFilters(){ return {status:E.fStatus.value||null, from:E.fFrom.value||null, to:E.fTo.value||null, q:E.fQ.value.trim()||null}; }

function pill(status){
  const cls = status==='Approved'?'st-Approved':status==='Declined'?'st-Declined':status==='Paid'?'st-Paid':'st-Pending';
  return `<span class="status-pill ${cls}">${status}</span>`;
}
function fmtAmt(a){ return "#"+Number(a||0).toLocaleString(); }

async function latestComment(id){
  const { data } = await sb.from('request_notes')
    .select('note,created_at').eq('request_id',id)
    .order('created_at',{ascending:false}).limit(10);
  const notes = (data||[]).filter(n=>!n.note.startsWith('receipt:'));
  return notes.length? notes[0].note : '';
}

async function loadMine(filters={}){
  const seq=++LOADSEQ;
  E.tbody.innerHTML='<tr><td colspan="4">Loading…</td></tr>';
  let q = sb.from('requests').select('*').eq('user_id', USER.id).order('created_at',{ascending:false});
  if(filters.status) q = q.eq('status',filters.status);
  if(filters.from) q = q.gte('created_at',filters.from+'T00:00:00Z');
  if(filters.to) q = q.lte('created_at',filters.to+'T23:59:59Z');
  if(filters.q) q = q.ilike('description', `%${filters.q}%`);
  const { data, error } = await q;
  if(seq!==LOADSEQ) return;
  if(error){E.tbody.innerHTML=`<tr><td colspan="4">${error.message}</td></tr>`;return;}

  E.tbody.innerHTML='';
  for(const r of data){
    const c = await latestComment(r.id);
    E.tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${pill(r.status)}</td>
        <td class="amount">${fmtAmt(r.amount)}</td>
        <td><div class="comment-box">${c||''}</div></td>
      </tr>
    `);
  }
}

/* Paid history (by month) */
async function loadPaid(){
  E.paidBody.innerHTML='<tr><td colspan="2">Loading…</td></tr>';
  const { data } = await sb.from('requests').select('amount,created_at').eq('user_id',USER.id).eq('status','Paid').order('created_at',{ascending:false});
  const groups={};
  (data||[]).forEach(r=>{
    const d=new Date(r.created_at); const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    groups[ym]=(groups[ym]||0)+Number(r.amount||0);
  });
  const rows=Object.entries(groups).sort((a,b)=>a[0]<b[0]?1:-1);
  E.paidBody.innerHTML = rows.length? '' : '<tr><td colspan="2">No paid items yet.</td></tr>';
  rows.forEach(([m,total])=> E.paidBody.insertAdjacentHTML('beforeend', `<tr><td>${m}</td><td>GBP ${total.toFixed(2)}</td></tr>`));
}

/* Realtime: refresh list on changes */
let ch=null;
function realtime(){
  if(ch) sb.removeChannel(ch);
  ch = sb.channel('req-'+USER.id)
    .on('postgres_changes',{event:'*',schema:'public',table:'requests',filter:`user_id=eq.${USER.id}`},()=>{loadMine(readFilters());loadPaid();})
    .subscribe();
}
</script>
</body>
      </html>    <h3>Staff Access</h3>
    <div class="row">
      <div><label>Email</label><input type="email" id="email" placeholder="you@julinemart.com" autocomplete="username"></div>
      <div><label>Password</label><input type="password" id="password" placeholder="Enter password" autocomplete="current-password"></div>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btn-login" class="btn primary" type="button">Log in</button>
      <button id="btn-register" class="btn" type="button">Register</button>
    </div>
    <p id="signin-msg" class="foot-note"></p>
    <p class="foot-note">Admin? <a class="switch" href="admin.html">Go to Admin</a></p>
  </div>

  <!-- NEW REQUEST -->
  <section class="card hidden" id="page-new">
    <h3>New Request</h3>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="kind">
          <option value="petty_cash">Petty Cash (advance)</option>
          <option value="reimbursement">Reimbursement (pay me back)</option>
        </select>
      </div>
      <div><label>Amount</label><input type="number" step="0.01" id="amount" placeholder="0.00"></div>
      <div><label>Currency</label>
        <select id="currency"><option>GBP</option><option>NGN</option><option>USD</option><option>EUR</option></select>
      </div>
      <div><label>Needed by (optional)</label><input type="date" id="needed_by"></div>
    </div>
    <label>Description / Purpose</label>
    <textarea id="description" placeholder="What is this for?"></textarea>

    <!-- multiple receipts -->
    <label>Receipts / Supporting docs (PNG/JPG/PDF — you can select multiple)</label>
    <input type="file" id="receipts" accept=".png,.jpg,.jpeg,.pdf" multiple>

    <div style="margin-top:10px"><button id="submit-request" class="btn primary" type="button">Submit</button></div>
    <p id="new-msg" class="foot-note"></p>
  </section>

  <!-- MY REQUESTS (exact format: DATE … STATUS … AMOUNT … COMMENT) -->
  <section class="card hidden" id="page-mine">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>My Requests</h3>
      <div class="toolbar">
        <select id="f-status">
          <option value="">Status: All</option>
          <option>Pending</option><option>Approved</option><option>Declined</option><option>Paid</option><option>Cancelled</option>
        </select>
        <input id="f-from" type="date" aria-label="From date">
        <input id="f-to" type="date" aria-label="To date">
        <input id="f-q" type="search" placeholder="Search description…" style="min-width:200px">
        <button id="btn-apply" class="btn" type="button">Apply</button>
        <button id="btn-clear" class="btn" type="button">Clear</button>
        <button id="btn-refresh" class="btn" type="button">Refresh</button>
      </div>
    </div>
    <table id="mine-table">
      <thead><tr><th>DATE</th><th>STATUS</th><th>AMOUNT</th><th>COMMENT</th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="foot-note" style="margin-top:10px">Tip: click a row to view full history.</p>
  </section>

  <!-- Paid History (kept as before) -->
  <section class="card hidden" id="page-paid">
    <h3>Paid History (by month)</h3>
    <div style="overflow:auto">
      <table id="paid-table">
        <thead><tr><th>Month</th><th>Total Paid</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Full history modal -->
<dialog id="dlg-history">
  <h3>Request history</h3>
  <div id="history-body" class="history-list"></div>
  <div style="text-align:right;margin-top:10px">
    <button id="btn-close" class="btn" type="button">Close</button>
  </div>
</dialog>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* Supabase (your project) */
const sb = supabase.createClient(
  "https://hmguraxzebhspednbbav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZ3VyYXh6ZWJoc3BlZG5iYmF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjM5OTEsImV4cCI6MjA3NDYzOTk5MX0.kEvWzQHbym23mIi92CJIJfMAwi5JpT0K5ZL5gFMok_o"
);

const el = id => document.getElementById(id);
const signinCard = el('signin-card'), pageNew = el('page-new'), pageMine = el('page-mine'), pagePaid = el('page-paid');
const whoami = el('whoami'), btnSignout = el('btn-signout');
const dlg = el('dlg-history'), histBody = el('history-body'), btnClose = el('btn-close');

let currentUser = null;
let INITIALIZED = false;
let LOAD_SEQ = 0;

function show(section){ [signinCard,pageNew,pageMine,pagePaid].forEach(s=>s.classList.add('hidden')); section.classList.remove('hidden'); }
btnSignout.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };
btnClose.onclick = ()=> dlg.close();

function setBusy(button, txt){ if(!button) return; button.dataset.prev = button.textContent; button.textContent = txt; button.disabled = true; }
function clearBusy(button){ if(!button) return; button.disabled = false; button.textContent = button.dataset.prev || button.textContent; }

/* ====== INIT + Realtime ====== */
async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  currentUser = session?.user ?? null;

  if(currentUser){
    whoami.textContent = currentUser.email;
    btnSignout.classList.remove('hidden');
    show(pageNew);
    loadMine();
    loadPaidHistory();
    enableRealtime();
  }else{
    whoami.textContent = "";
    btnSignout.classList.add('hidden');
    show(signinCard);
  }
}
function initOnce(){ if (INITIALIZED) return; INITIALIZED = true; init(); }
sb.auth.onAuthStateChange(()=>initOnce()); initOnce();

let rtChannel = null;
function enableRealtime(){
  try{
    if(rtChannel) sb.removeChannel(rtChannel);
    rtChannel = sb.channel('req-status-'+currentUser.id)
      .on('postgres_changes',{ event:'*', schema:'public', table:'requests', filter:`user_id=eq.${currentUser.id}`}, payload=>{
        loadMine(); loadPaidHistory();
      }).subscribe();
  }catch(e){ console.warn('Realtime subscribe failed', e); }
}

/* ====== AUTH ====== */
el('btn-login').onclick = async (e)=>{
  e.preventDefault();
  const btn = e.currentTarget;
  const email = el('email').value.trim();
  const password = el('password').value.trim();
  if(!email || !password){ el('signin-msg').textContent = "Enter email & password."; return; }
  setBusy(btn, "Logging in…");
  try{
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    location.reload();
  }catch(err){ el('signin-msg').textContent = err.message || String(err); }
  finally{ clearBusy(btn); }
};

el('btn-register').onclick = async (e)=>{
  e.preventDefault();
  const btn = e.currentTarget;
  const email = el('email').value.trim();
  const password = el('password').value.trim();
  if(!email || !password){ el('signin-msg').textContent = "Enter email & password."; return; }
  setBusy(btn, "Registering…");
  try{
    const { data, error } = await sb.auth.signUp({ email, password });
    if(error) throw error;
    if(data && data.session){ location.reload(); }
    else { el('signin-msg').textContent = "Registered! Please log in."; }
  }catch(err){ el('signin-msg').textContent = err.message || String(err); }
  finally{ clearBusy(btn); }
};

/* ====== Upload many receipts ====== */
async function uploadOne(file){
  const ext=(file.name.split('.').pop()||'bin').toLowerCase();
  const path=`receipts/${currentUser.id}/${crypto.randomUUID()}.${ext}`;
  const { data, error } = await sb.storage.from('receipts').upload(path, file, { upsert:false, contentType:file.type||'application/octet-stream' });
  if(error){ console.warn('upload error', error); return null; }
  return data.path;
}

/* ====== Submit new request ====== */
el('submit-request').onclick = async (e)=>{
  e.preventDefault();
  try{
    if(!currentUser){ el('new-msg').textContent = "Please log in first."; return; }
    const kind = el('kind').value;
    const amount = parseFloat(el('amount').value || '0');
    const currency = el('currency').value;
    const needed_by = el('needed_by').value || null;
    const description = el('description').value.trim();
    if(!description || !(amount > 0)){ el('new-msg').textContent = "Fill description and amount."; return; }

    const { data: req, error } = await sb.from('requests')
      .insert({ user_id: currentUser.id, kind, amount, currency, needed_by, description })
      .select().single();
    if(error){ el('new-msg').textContent = error.message; return; }

    const files = [...el('receipts').files];
    for (const f of files){
      const p = await uploadOne(f);
      if(p) await sb.from('request_notes').insert({ request_id: req.id, author_id: currentUser.id, note:`receipt:${p}` });
    }

    el('new-msg').textContent = "Request submitted.";
    el('amount').value=""; el('description').value=""; el('needed_by').value=""; el('receipts').value="";
    loadMine(); loadPaidHistory();
  }catch(err){ el('new-msg').textContent = err.message || String(err); }
};

/* ====== Helpers for list ====== */
function pill(s){ return `<span class="pill ${s}">${s}</span>`; }
function fmt(a,c){ return `${c} ${Number(a).toFixed(2)}`; }

async function latestComment(requestId){
  // latest non-receipt note, most recent first
  const { data, error } = await sb.from('request_notes')
    .select('note, created_at, author_id')
    .eq('request_id', requestId)
    .order('created_at', { ascending:false })
    .limit(10);
  if(error || !data || !data.length) return 'Awaiting review';
  const candidates = data.filter(n => !n.note.startsWith('receipt:'));
  if(!candidates.length) return 'Awaiting review';
  return candidates[0].note;
}

async function fullHistory(requestId){
  const { data, error } = await sb.from('request_notes')
    .select('note, created_at, author_id')
    .eq('request_id', requestId)
    .order('created_at', { ascending:true });
  return error ? [] : data;
}

/* ====== Filters ====== */
el('btn-apply').onclick = ()=> loadMine(readFilters());
el('btn-clear').onclick = ()=>{ el('f-status').value=''; el('f-from').value=''; el('f-to').value=''; el('f-q').value=''; loadMine({}); };
el('btn-refresh').onclick = ()=> loadMine(readFilters());
function readFilters(){ return { status:el('f-status').value||null, from:el('f-from').value||null, to:el('f-to').value||null, q:el('f-q').value.trim()||null }; }

/* ====== Load list (DATE … STATUS … AMOUNT … COMMENT) ====== */
async function loadMine(filters={}){
  const seq = ++LOAD_SEQ;
  const tbody=document.querySelector('#mine-table tbody');
  tbody.innerHTML='<tr><td colspan="4">Loading…</td></tr>';

  let q = sb.from('requests').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:false});
  if(filters.status) q=q.eq('status',filters.status);
  if(filters.from) q=q.gte('created_at',filters.from+'T00:00:00Z');
  if(filters.to)   q=q.lte('created_at',filters.to+'T23:59:59Z');
  if(filters.q)    q=q.ilike('description', `%${filters.q}%`);

  const { data, error } = await q;
  if(seq !== LOAD_SEQ) return;
  if(error){ tbody.innerHTML = `<tr><td colspan="4">${error.message}</td></tr>`; return; }

  tbody.innerHTML='';
  for (const r of data){
    const comment = await latestComment(r.id);
    const rowHtml = `
      <tr data-id="${r.id}" style="cursor:pointer">
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>${pill(r.status)}</td>
        <td>${fmt(r.amount,r.currency)}</td>
        <td>${comment}</td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', rowHtml);
  }

  // click row -> open full history
  tbody.querySelectorAll('tr[data-id]').forEach(tr=>{
    tr.onclick = async ()=>{
      const rid = tr.getAttribute('data-id');
      const notes = await fullHistory(rid);
      histBody.innerHTML = notes.length ? '' : '<div class="history-item">No history yet.</div>';
      notes.forEach(n=>{
        const d = new Date(n.created_at).toLocaleString();
        histBody.insertAdjacentHTML('beforeend', `<div class="history-item"><b>${d}</b> — ${n.note}</div>`);
      });
      dlg.showModal();
    };
  });

  // show Paid history card too
  pagePaid.classList.remove('hidden');
}

/* ====== Paid History (monthly) ====== */
async function loadPaidHistory(){
  const tbody = document.querySelector('#paid-table tbody');
  tbody.innerHTML = '<tr><td colspan="2">Loading…</td></tr>';
  const { data, error } = await sb
    .from('requests')
    .select('amount, currency, created_at')
    .eq('user_id', currentUser.id)
    .eq('status', 'Paid')
    .order('created_at',{ascending:false});
  if(error){ tbody.innerHTML = `<tr><td colspan="2">${error.message}</td></tr>`; return; }

  const groups = {};
  for(const r of data){
    const d = new Date(r.created_at);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    groups[ym] = (groups[ym] || 0) + Number(r.amount || 0);
  }
  const rows = Object.entries(groups).sort((a,b)=> a[0]<b[0]?1:-1);
  tbody.innerHTML = rows.length? '' : '<tr><td colspan="2">No paid items yet.</td></tr>';
  for(const [ym, total] of rows){
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${ym}</td><td>GBP ${total.toFixed(2)}</td></tr>`);
  }
}

/* PWA */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}
</script>
</body>
</html>
